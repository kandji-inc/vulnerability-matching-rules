import argparse
import os
import orjson
from pydantic import ValidationError

from pydantic_model import *
from pprint import pprint


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("rules_path")
    parser.add_argument("schema_path")
    args = parser.parse_args()

    rules = []
    for location in sorted(os.listdir(args.rules_path), key=lambda l: int(l.split('_')[-1].rstrip('.json'))):
        with open(f"{args.rules_path}/{location}") as f:
            rules.append((orjson.loads(f.read()), location))

    invalid_rules = []
    # check rules
    for r, f in rules:
        try:
            VulnerabilityMatchingRule.parse_obj(r)
        except ValidationError as e:
            invalid_rules.append({f: str(e)})

    if invalid_rules:
        pprint(invalid_rules)
        exit(1)


if __name__ == "__main__":
    main()
