FROM docker.tooling.internal-kandji.io/dockerhub/library/python:3.10 AS production

ARG CLOUDSMITH_API_KEY
ARG CLOUDSMITH_USERNAME
ARG CF_REVISION

ENV PIP_EXTRA_INDEX_URL "https://${CLOUDSMITH_USERNAME}:${CLOUDSMITH_API_KEY}@dl.cloudsmith.io/basic/kandji/pypi/python/simple"
ENV PIP_NO_INPUT 1

### Copy deployment scripts in
COPY deploy deploy

COPY Makefile Makefile

### Install Python dependencies
RUN pip install --requirement deploy/requirements.txt

### Symlink command
RUN echo $PATH && ln -s $(pwd)/deploy/vuln-deploy.sh /usr/local/bin/vuln-deploy

### Copy rules in
COPY rules rules